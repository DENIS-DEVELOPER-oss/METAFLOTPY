
{% extends "base.html" %}

{% block titulo %}Gates-Gaudin-Schuhmann - MetaFlotPy{% endblock %}

{% block contenido %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('tamizado.analisis_granulometrico') }}">Análisis de Tamaño de Partícula</a></li>
                    <li class="breadcrumb-item active">Gates-Gaudin-Schuhmann</li>
                </ol>
            </nav>
            <h1><i class="bi bi-1-circle"></i> Gates-Gaudin-Schuhmann (GGS)</h1>
            <p class="lead">Análisis granulométrico con modelo Gates-Gaudin-Schuhmann</p>
        </div>
    </div>

    <!-- Formulario de entrada de datos -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-clipboard-data"></i> Datos de Entrada</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="formulario-tamizado">
                        {{ formulario.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ formulario.peso_total.label(class="form-label") }}
                                    {{ formulario.peso_total(class="form-control") }}
                                    <div class="form-text">T: Peso total de muestra (g) → campo único</div>
                                </div>
                            </div>
                        </div>

                        <h6><i class="bi bi-table"></i> Datos de Mallas</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Malla</th>
                                        <th>Abertura (mm)</th>
                                        <th>Peso Retenido (g)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1/2"</td>
                                        <td>12.5</td>
                                        <td>{{ formulario.retenido_12_5(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>3/8"</td>
                                        <td>9.5</td>
                                        <td>{{ formulario.retenido_9_5(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>1/4"</td>
                                        <td>6.35</td>
                                        <td>{{ formulario.retenido_6_35(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 4</td>
                                        <td>4.75</td>
                                        <td>{{ formulario.retenido_4_75(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 6</td>
                                        <td>3.35</td>
                                        <td>{{ formulario.retenido_3_35(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 8</td>
                                        <td>2.36</td>
                                        <td>{{ formulario.retenido_2_36(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 16</td>
                                        <td>1.18</td>
                                        <td>{{ formulario.retenido_1_18(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 20</td>
                                        <td>0.85</td>
                                        <td>{{ formulario.retenido_0_85(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 30</td>
                                        <td>0.60</td>
                                        <td>{{ formulario.retenido_0_60(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 40</td>
                                        <td>0.425</td>
                                        <td>{{ formulario.retenido_0_425(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 50</td>
                                        <td>0.30</td>
                                        <td>{{ formulario.retenido_0_30(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 70</td>
                                        <td>0.212</td>
                                        <td>{{ formulario.retenido_0_212(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 100</td>
                                        <td>0.150</td>
                                        <td>{{ formulario.retenido_0_150(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 140</td>
                                        <td>0.106</td>
                                        <td>{{ formulario.retenido_0_106(class="form-control") }}</td>
                                    </tr>
                                    <tr>
                                        <td>No. 200</td>
                                        <td>0.075</td>
                                        <td>{{ formulario.retenido_0_075(class="form-control") }}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td>Fondo</td>
                                        <td>-</td>
                                        <td>{{ formulario.retenido_fondo(class="form-control") }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="text-center mt-3">
                            {{ formulario.calcular(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-info-circle"></i> Modelo Gates-Gaudin-Schuhmann</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="bi bi-database"></i> Datos de entrada:</h6>
                        <ul class="small">
                            <li><strong>d:</strong> Tamaño de partícula (mm o μm)</li>
                            <li><strong>d<sub>max</sub>:</strong> Tamaño máximo de partícula en la muestra</li>
                            <li><strong>P(d):</strong> Porcentaje acumulado pasante para d</li>
                            <li><strong>n:</strong> Exponente de distribución (calculado por regresión)</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6><i class="bi bi-calculator-fill"></i> Fórmula:</h6>
                        <div class="formula-box bg-light p-3 rounded text-center border">
                            <strong>P(d) = (d/d<sub>max</sub>)<sup>n</sup> × 100</strong>
                        </div>
                        <div class="mt-2">
                            <small><strong>Donde:</strong></small>
                            <ul class="small">
                                <li><strong>P(d):</strong> % acumulado pasante</li>
                                <li><strong>d:</strong> tamaño de partícula</li>
                                <li><strong>d<sub>max</sub>:</strong> tamaño máximo</li>
                                <li><strong>n:</strong> pendiente obtenida por regresión log-log</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6><i class="bi bi-graph-up"></i> Gráfico recomendado:</h6>
                        <ul class="small">
                            <li><strong>Eje X:</strong> log(d)</li>
                            <li><strong>Eje Y:</strong> log(P(d))</li>
                            <li><strong>Tipo:</strong> Gráfico log-log (línea recta si el modelo es válido)</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6><i class="bi bi-info-circle"></i> Interpretación:</h6>
                        <ul class="small">
                            <li>Se ajusta bien para materiales de molienda gruesa.</li>
                            <li>La pendiente <strong>n</strong> define la uniformidad de la molienda.</li>
                            <li>Una línea recta en log-log valida el modelo.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    {% if resultados %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-table"></i> Resultados del Análisis Granulométrico</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Abertura (mm)</th>
                                    <th>Peso Retenido (g)</th>
                                    <th>% Retenido</th>
                                    <th>% Retenido Acum.</th>
                                    <th>% Pasante</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fila in resultados.tabla %}
                                <tr>
                                    <td>{{ "%.3f"|format(fila.malla) }}</td>
                                    <td>{{ "%.2f"|format(fila.peso_retenido) }}</td>
                                    <td>{{ "%.2f"|format(fila.porcentaje_retenido) }}</td>
                                    <td>{{ "%.2f"|format(fila.retenido_acumulado) }}</td>
                                    <td>{{ "%.2f"|format(fila.pasante) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Parámetros Característicos:</h6>
                            <table class="table table-sm">
                                <tr><td>D10:</td><td><span class="badge bg-info">{{ resultados.d10 }} mm</span></td></tr>
                                <tr><td>D30:</td><td><span class="badge bg-info">{{ resultados.d30 }} mm</span></td></tr>
                                <tr><td>D50:</td><td><span class="badge bg-info">{{ resultados.d50 }} mm</span></td></tr>
                                <tr><td>D60:</td><td><span class="badge bg-info">{{ resultados.d60 }} mm</span></td></tr>
                                <tr><td>D80:</td><td><span class="badge bg-info">{{ resultados.d80 }} mm</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Coeficientes:</h6>
                            <table class="table table-sm">
                                <tr><td>Coef. Uniformidad (Cu):</td><td><span class="badge bg-success">{{ resultados.cu }}</span></td></tr>
                                <tr><td>Coef. Curvatura (Cc):</td><td><span class="badge bg-success">{{ resultados.cc }}</span></td></tr>
                                <tr><td>Balance:</td><td>
                                    {% if resultados.balance_ok %}
                                    <span class="badge bg-success">OK</span>
                                    {% else %}
                                    <span class="badge bg-warning">Error: {{ "%.2f"|format(resultados.error_balance) }}g</span>
                                    {% endif %}
                                </td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico -->
    {% if grafico %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up"></i> Curva Granulométrica Gates-Gaudin-Schuhmann</h5>
                </div>
                <div class="card-body">
                    <div id="grafico-granulometrico"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<style>
.formula-box {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
</style>

<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
{% if grafico %}
var grafico_data = {{ grafico|safe }};
Plotly.newPlot('grafico-granulometrico', grafico_data.data, grafico_data.layout, {responsive: true});
{% endif %}
</script>
{% endblock %}
