
{% extends "base.html" %}

{% block titulo %}Análisis Granulométrico - MetaFlotPy{% endblock %}

{% block contenido %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="bi bi-grid"></i> Análisis de Tamaño de Partícula</h1>
            <p class="lead">Análisis granulométrico y curvas de distribución</p>
        </div>
    </div>

    <!-- Navegación por pestañas -->
    <ul class="nav nav-tabs" id="analisisTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="gates-tab" data-bs-toggle="tab" data-bs-target="#gates" type="button" role="tab">
                <i class="bi bi-graph-up"></i> Gates Gaudin Schuhmann
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rosin-tab" data-bs-toggle="tab" data-bs-target="#rosin" type="button" role="tab">
                <i class="bi bi-activity"></i> Rosin Rammler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="regresion-tab" data-bs-toggle="tab" data-bs-target="#regresion" type="button" role="tab">
                <i class="bi bi-graph-down"></i> Regresión Lineal
            </button>
        </li>
    </ul>

    <div class="tab-content" id="analisisTabContent">
        <!-- Gates Gaudin Schuhmann -->
        <div class="tab-pane fade show active" id="gates" role="tabpanel">
            <!-- Información del modelo -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5><i class="bi bi-info-circle text-primary"></i> Modelo Gates-Gaudin-Schuhmann (GGS)</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-clipboard-data"></i> Datos de entrada:</h6>
                                    <ul class="small">
                                        <li><strong>d</strong>: Tamaño de partícula (μm o mm)</li>
                                        <li><strong>d<sub>máx</sub></strong>: Tamaño máximo (μm o mm)</li>
                                        <li><strong>P(d)</strong>: % acumulado pasante para d (dato a calcular)</li>
                                        <li><strong>n</strong>: Exponente de distribución</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-calculator-fill text-danger"></i> Fórmula:</h6>
                                    <div class="bg-white p-2 border rounded text-center">
                                        <math>P(d) = (d/d<sub>máx</sub>)<sup>n</sup> × 100</math>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="bi bi-graph-up"></i> Gráfico recomendado:</h6>
                                    <ul class="small">
                                        <li>Eje X: Tamaño de partícula log(d)</li>
                                        <li>Eje Y: % acumulado pasante log(P(d))</li>
                                        <li>Tipo: Gráfico log-log (línea recta si el modelo se ajusta bien)</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-lightbulb"></i> Interpretación:</h6>
                                    <ul class="small">
                                        <li>Se usa principalmente para materiales con distribución gruesa</li>
                                        <li>Si se ajusta linealmente en el log-log, el modelo es adecuado</li>
                                        <li>El exponente <strong>n</strong> indica la uniformidad: menor n → distribución más gruesa</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-calculator"></i> Datos de Entrada - Gates Gaudin Schuhmann</h5>
                        </div>
                        <div class="card-body">
                            <form id="formGates" method="POST">
                                <input type="hidden" name="modelo" value="gates">
                                {{ formulario.hidden_tag() if formulario }}
                                
                                <div class="mb-3">
                                    <label class="form-label">Peso Total de Muestra (g)</label>
                                    <input type="number" class="form-control" name="peso_total" step="0.01" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Datos de Mallas</label>
                                    <div id="mallasGates">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Abertura (mm)" name="abertura[]" step="0.001" required>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Peso Retenido (g)" name="peso_retenido[]" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarMalla('mallasGates')">
                                        <i class="bi bi-plus"></i> Agregar Malla
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-graph-up"></i> Calcular Gates Gaudin Schuhmann
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up"></i> Resultados Gates Gaudin Schuhmann</h5>
                        </div>
                        <div class="card-body">
                            <div id="graficoGates">
                                {% if grafico_gates %}
                                <div id="plotGates"></div>
                                <script>
                                    var graficoGates = {{ grafico_gates|safe }};
                                    Plotly.newPlot('plotGates', graficoGates.data, graficoGates.layout);
                                </script>
                                {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-graph-up display-1"></i>
                                    <p>El gráfico aparecerá aquí después del cálculo</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if resultados_gates %}
                            <div class="mt-3">
                                <h6>Parámetros del Modelo Gates-Gaudin-Schuhmann:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Tamaño Máximo (d<sub>máx</sub>):</strong>
                                        <span class="badge bg-primary">{{ "%.3f"|format(resultados_gates.k) }} mm</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Exponente de Distribución (n):</strong>
                                        <span class="badge bg-info">{{ "%.3f"|format(resultados_gates.m) }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Coeficiente de Correlación (R²):</strong>
                                        <span class="badge bg-success">{{ "%.4f"|format(resultados_gates.r2) }}</span>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Ecuación del modelo:</strong>
                                        <div class="bg-light p-2 mt-2 rounded text-center">
                                            P(d) = (d/{{ "%.3f"|format(resultados_gates.k) }})<sup>{{ "%.3f"|format(resultados_gates.m) }}</sup> × 100
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rosin Rammler -->
        <div class="tab-pane fade" id="rosin" role="tabpanel">
            <!-- Información del modelo -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5><i class="bi bi-info-circle text-success"></i> Modelo Rosin-Rammler</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-clipboard-data"></i> Datos de entrada:</h6>
                                    <ul class="small">
                                        <li><strong>d</strong>: Tamaño de partícula (μm o mm)</li>
                                        <li><strong>d<sub>0</sub></strong>: Tamaño característico donde el 36.8% de las partículas son más grandes</li>
                                        <li><strong>n</strong>: Parámetro de distribución</li>
                                        <li><strong>R(d)</strong>: % retenido acumulado (dato a calcular)</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-calculator-fill text-danger"></i> Fórmula:</h6>
                                    <div class="bg-white p-2 border rounded text-center">
                                        <div>R(d) = 100 × e<sup>-(d/d₀)ⁿ</sup></div>
                                        <div class="mt-2 small">O también: ln[-ln(R(d)/100)] = n × ln(d) - n × ln(d₀)</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="bi bi-graph-up"></i> Gráfico recomendado:</h6>
                                    <ul class="small">
                                        <li>Eje X: ln(d)</li>
                                        <li>Eje Y: ln[-ln(R(d)/100)]</li>
                                        <li>Tipo: Gráfico semilogarítmico (línea recta si el modelo es adecuado)</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-lightbulb"></i> Interpretación:</h6>
                                    <ul class="small">
                                        <li>Muy usado en molienda fina o polvos</li>
                                        <li>El parámetro <strong>n</strong> define la pendiente (dispersión)</li>
                                        <li><strong>d₀</strong> define la centralidad de la distribución</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-calculator"></i> Datos de Entrada - Rosin Rammler</h5>
                        </div>
                        <div class="card-body">
                            <form id="formRosin" method="POST">
                                <input type="hidden" name="modelo" value="rosin">
                                
                                <div class="mb-3">
                                    <label class="form-label">Peso Total de Muestra (g)</label>
                                    <input type="number" class="form-control" name="peso_total" step="0.01" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Datos de Mallas</label>
                                    <div id="mallasRosin">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Abertura (mm)" name="abertura[]" step="0.001" required>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Peso Retenido (g)" name="peso_retenido[]" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarMalla('mallasRosin')">
                                        <i class="bi bi-plus"></i> Agregar Malla
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-activity"></i> Calcular Rosin Rammler
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-activity"></i> Resultados Rosin Rammler</h5>
                        </div>
                        <div class="card-body">
                            <div id="graficoRosin">
                                {% if grafico_rosin %}
                                <div id="plotRosin"></div>
                                <script>
                                    var graficoRosin = {{ grafico_rosin|safe }};
                                    Plotly.newPlot('plotRosin', graficoRosin.data, graficoRosin.layout);
                                </script>
                                {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-activity display-1"></i>
                                    <p>El gráfico aparecerá aquí después del cálculo</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if resultados_rosin %}
                            <div class="mt-3">
                                <h6>Parámetros del Modelo Rosin-Rammler:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Tamaño Característico (d₀):</strong>
                                        <span class="badge bg-primary">{{ "%.3f"|format(resultados_rosin.x0) }} mm</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Parámetro de Distribución (n):</strong>
                                        <span class="badge bg-info">{{ "%.3f"|format(resultados_rosin.n) }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Coeficiente de Correlación (R²):</strong>
                                        <span class="badge bg-success">{{ "%.4f"|format(resultados_rosin.r2) }}</span>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Ecuación del modelo:</strong>
                                        <div class="bg-light p-2 mt-2 rounded text-center">
                                            R(d) = 100 × e<sup>-(d/{{ "%.3f"|format(resultados_rosin.x0) }})<sup>{{ "%.3f"|format(resultados_rosin.n) }}</sup></sup>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Regresión Lineal -->
        <div class="tab-pane fade" id="regresion" role="tabpanel">
            <!-- Información del modelo -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5><i class="bi bi-info-circle text-warning"></i> Regresión Lineal (Ajuste de curva empírica)</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-clipboard-data"></i> Datos de entrada:</h6>
                                    <ul class="small">
                                        <li><strong>x</strong>: Tamaño de partícula (generalmente en escala logarítmica)</li>
                                        <li><strong>y</strong>: % acumulado pasante o retenido</li>
                                        <li>Se tienen pares de datos (x<sub>i</sub>, y<sub>i</sub>)</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-calculator-fill text-danger"></i> Fórmula:</h6>
                                    <div class="bg-white p-2 border rounded">
                                        <div class="text-center">y = a × x + b</div>
                                        <div class="mt-2 small">donde:</div>
                                        <ul class="small mb-0">
                                            <li><strong>a</strong>: pendiente</li>
                                            <li><strong>b</strong>: intersección</li>
                                        </ul>
                                        
                                        <div class="mt-3 small"><strong>Usa método de mínimos cuadrados:</strong></div>
                                        <div class="text-center small">
                                            <div>a = (n∑x<sub>i</sub>y<sub>i</sub> - ∑x<sub>i</sub>∑y<sub>i</sub>) / (n∑x<sub>i</sub>² - (∑x<sub>i</sub>)²)</div>
                                            <div>b = (∑y<sub>i</sub> - a∑x<sub>i</sub>) / n</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6><i class="bi bi-graph-up"></i> Gráfico recomendado:</h6>
                                    <ul class="small">
                                        <li>Eje X: tamaño (log(d)) o d directamente</li>
                                        <li>Eje Y: % acumulado pasante</li>
                                        <li>Tipo: Diagrama de dispersión con línea de tendencia</li>
                                    </ul>
                                    
                                    <h6><i class="bi bi-lightbulb"></i> Interpretación:</h6>
                                    <ul class="small">
                                        <li>Se puede usar para ajustar cualquier modelo</li>
                                        <li>El R² (coeficiente de determinación) indica qué tan bueno es el ajuste</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-calculator"></i> Datos de Entrada - Regresión Lineal</h5>
                        </div>
                        <div class="card-body">
                            <form id="formRegresion" method="POST">
                                <input type="hidden" name="modelo" value="regresion">
                                
                                <div class="mb-3">
                                    <label class="form-label">Peso Total de Muestra (g)</label>
                                    <input type="number" class="form-control" name="peso_total" step="0.01" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Datos de Mallas</label>
                                    <div id="mallasRegresion">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Abertura (mm)" name="abertura[]" step="0.001" required>
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="Peso Retenido (g)" name="peso_retenido[]" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarMalla('mallasRegresion')">
                                        <i class="bi bi-plus"></i> Agregar Malla
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-graph-down"></i> Calcular Regresión Lineal
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-down"></i> Resultados Regresión Lineal</h5>
                        </div>
                        <div class="card-body">
                            <div id="graficoRegresion">
                                {% if grafico_regresion %}
                                <div id="plotRegresion"></div>
                                <script>
                                    var graficoRegresion = {{ grafico_regresion|safe }};
                                    Plotly.newPlot('plotRegresion', graficoRegresion.data, graficoRegresion.layout);
                                </script>
                                {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-graph-down display-1"></i>
                                    <p>El gráfico aparecerá aquí después del cálculo</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if resultados_regresion %}
                            <div class="mt-3">
                                <h6>Parámetros de la Regresión Lineal:</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Pendiente (a):</strong>
                                        <span class="badge bg-primary">{{ "%.4f"|format(resultados_regresion.pendiente) }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Intercepto (b):</strong>
                                        <span class="badge bg-info">{{ "%.4f"|format(resultados_regresion.intercepto) }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <strong>Coeficiente de Determinación (R²):</strong>
                                        <span class="badge bg-success">{{ "%.4f"|format(resultados_regresion.r2) }}</span>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Ecuación de la recta:</strong>
                                        <div class="bg-light p-2 mt-2 rounded text-center">
                                            y = {{ "%.4f"|format(resultados_regresion.pendiente) }}x + {{ "%.4f"|format(resultados_regresion.intercepto) }}
                                        </div>
                                        <small class="text-muted">donde x = log(tamaño) e y = % pasante</small>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de datos común -->
    {% if tabla_datos %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-table"></i> Tabla de Datos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Abertura (mm)</th>
                                    <th>Peso Retenido (g)</th>
                                    <th>% Retenido</th>
                                    <th>% Acumulado</th>
                                    <th>% Pasante</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fila in tabla_datos %}
                                <tr>
                                    <td>{{ "%.3f"|format(fila.abertura) }}</td>
                                    <td>{{ "%.2f"|format(fila.peso_retenido) }}</td>
                                    <td>{{ "%.2f"|format(fila.porcentaje_retenido) }}</td>
                                    <td>{{ "%.2f"|format(fila.porcentaje_acumulado) }}</td>
                                    <td>{{ "%.2f"|format(fila.porcentaje_pasante) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
function agregarMalla(containerId) {
    const container = document.getElementById(containerId);
    const nuevaFila = document.createElement('div');
    nuevaFila.className = 'row mb-2';
    nuevaFila.innerHTML = `
        <div class="col-5">
            <input type="number" class="form-control" placeholder="Abertura (mm)" name="abertura[]" step="0.001" required>
        </div>
        <div class="col-5">
            <input type="number" class="form-control" placeholder="Peso Retenido (g)" name="peso_retenido[]" step="0.01" required>
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(nuevaFila);
}

// Inicializar con algunas mallas por defecto
document.addEventListener('DOMContentLoaded', function() {
    const mallas_estandar = [25.4, 19.0, 12.7, 9.51, 6.35, 4.75, 2.38, 1.19];
    
    ['mallasGates', 'mallasRosin', 'mallasRegresion'].forEach(containerId => {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Limpiar
        
        mallas_estandar.forEach(abertura => {
            const nuevaFila = document.createElement('div');
            nuevaFila.className = 'row mb-2';
            nuevaFila.innerHTML = `
                <div class="col-5">
                    <input type="number" class="form-control" placeholder="Abertura (mm)" name="abertura[]" step="0.001" value="${abertura}" required>
                </div>
                <div class="col-5">
                    <input type="number" class="form-control" placeholder="Peso Retenido (g)" name="peso_retenido[]" step="0.01" required>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(nuevaFila);
        });
    });
});
</script>
{% endblock %}
